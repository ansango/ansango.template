---
/**
 * ğŸ—ƒï¸ ArchiveList Organism
 * 
 * @description Chronological archive grouped by year.
 * Displays all entries organized by publication year in descending order.
 * 
 * @usage
 * ```astro
 * <ArchiveList entries={allEntries} page={1} isIndex={true} />
 * ```
 * 
 * @compatible
 * - ğŸ“… Groups entries by year automatically
 * - ğŸ“„ Supports pagination
 * - ğŸ“ Shows entry date, title, and collection
 * - ğŸ”¢ Handles entries without dates
 */
import { site } from "@/constants";
import {
  getCollectionsByYear,
  getPagination,
  type Entry,
} from "@/lib/collections";
import { getFormatDate } from "@/lib/utils";

interface Props {
  entries: Entry[];
  page?: number;
  isIndex: boolean;
}

const { entries, isIndex, page = 1 } = Astro.props;
const { paginatedEntries } = getPagination({
  isIndex,
  entries,
  page,
  entriesPerPage: site.pages.archive.entriesPerPage,
});
const parsedEntriesByYear = getCollectionsByYear(paginatedEntries);
---

{
  Object.entries(parsedEntriesByYear)
    .sort(([yearA], [yearB]) => {
      const yearANum = parseInt(yearA);
      const yearBNum = parseInt(yearB);
      if (isNaN(yearANum) && isNaN(yearBNum)) return 0;
      if (isNaN(yearANum)) return -1;
      if (isNaN(yearBNum)) return 1;
      return yearBNum - yearANum;
    })
    .map(([year, entries]) => {
      return (
        <section>
          <h2 class="m-0 mb-2 text-xl font-semibold">
            {isNaN(parseInt(year)) ? "Sin fecha" : year}
          </h2>
          <ul class="m-0 list-none space-y-2">
            {entries.map(({ collection, id, data: { date, title, index } }) => {
              return (
                <li class="flex list-none items-center gap-3">
                  <a
                    class="flex items-baseline gap-2"
                    href={`/${collection}` + (index ? "" : `/${id}`)}
                  >
                    {date && (
                      <time
                        class="text-muted min-w-20 text-sm whitespace-nowrap"
                        datetime={getFormatDate(date)}
                      >
                        {getFormatDate(date, "es-ES", {
                          year: "numeric",
                          month: "2-digit",
                        })
                          .split("/")
                          .reverse()
                          .join(" Â· ")}
                      </time>
                    )}

                    <u class="line-clamp-1">{title}</u>
                  </a>
                  <a
                    href={`/${collection}`}
                    class="text-muted hover:text-link inline text-sm whitespace-nowrap italic"
                  >
                    {collection}
                  </a>
                </li>
              );
            })}
          </ul>
        </section>
      );
    })
}
