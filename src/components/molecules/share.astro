---
/**
 * ðŸ“¤ Share Component
 *
 * @description Subscription and sharing section for blog entries.
 * Provides RSS feed link and copy URL functionality with view count from GoatCounter.
 *
 * @usage
 * ```astro
 * <Share url="https://ansango.dev/blog/my-post" />
 * ```
 *
 * @compatible
 * - ðŸ“¡ Uses RssIcon for feed subscription
 * - ðŸ“‹ Includes CopyIcon and CopiedIcon for URL copying
 * - ðŸ”˜ Built with Button component
 * - ðŸ“ˆ Displays view count if available
 */
import { site } from "@/constants";
import { RssIcon, CopyIcon, CopiedIcon } from "@/components/icons";
import { Button } from "@/components/atoms";

interface Props {
  url: string;
}

const { url } = Astro.props;
const rssUrl = `${site.url}/rss.xml`;

let viewCount: number | null = null;
const goatCounterCode = import.meta.env.PUBLIC_GOATCOUNTER_CODE;

if (goatCounterCode) {
  try {
    const path = new URL(url).pathname;
    const response = await fetch(
      `https://${goatCounterCode}.goatcounter.com/counter${path}.json`,
    );
    if (response.ok) {
      const data = await response.json();
      viewCount = data.count || 0;
    }
  } catch (error) {
    console.warn("Failed to fetch GoatCounter views:", error);
  }
}
---

<aside class="border-divider border-t py-4">
  <h3 class="mb-2 text-sm font-medium">
    SuscrÃ­bete para recibir actualizaciones
  </h3>

  <p class="text-muted mt-1.5 text-sm">
    Usa tu lector RSS favorito para seguir este sitio, o comparte esta
    publicaciÃ³n.
  </p>

  <div class="flex flex-wrap gap-3">
    <Button href={rssUrl} blank ariaLabel="Suscribirse al RSS feed">
      <RssIcon />
      <span>RSS Feed</span>
    </Button>

    <Button id="copy-rss-btn" data-url={url} ariaLabel="Copiar URL del RSS">
      <span id="copy-rss-icon">
        <CopyIcon />
      </span>
      <span id="copied-rss-icon" class="hidden">
        <CopiedIcon />
      </span>
      <span id="copy-rss-text">Copiar URL</span>
    </Button>
  </div>
  {
    viewCount !== null && viewCount > 0 && (
      <p class="text-muted/70 mt-1.5 mb-0 text-xs">
        Este artÃ­culo lleva {viewCount}{" "}
        {viewCount === 1 ? "lectura" : "lecturas"}.
      </p>
    )
  }
</aside>

<script>
  function setupCopyRSS() {
    const copyBtn = document.getElementById("copy-rss-btn");
    const copyText = document.getElementById("copy-rss-text");
    const copyIcon = document.getElementById("copy-rss-icon");
    const copiedIcon = document.getElementById("copied-rss-icon");

    if (!copyBtn) return;

    copyBtn.addEventListener("click", async () => {
      const url = copyBtn.getAttribute("data-url");
      if (!url) return;

      try {
        await navigator.clipboard.writeText(url);
        if (copyText && copyIcon && copiedIcon) {
          copyText.textContent = "Â¡Copiado!";
          copyIcon.classList.add("hidden");
          copiedIcon.classList.remove("hidden");

          setTimeout(() => {
            copyText.textContent = "Copiar URL";
            copyIcon.classList.remove("hidden");
            copiedIcon.classList.add("hidden");
          }, 2000);
        }
      } catch (err) {
        console.error("Error al copiar:", err);
      }
    });
  }

  setupCopyRSS();
  document.addEventListener("astro:page-load", setupCopyRSS);
</script>
